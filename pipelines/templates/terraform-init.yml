# Terraform Initialization Template
# Reusable template for Terraform initialization across workspaces

parameters:
  - name: workspacePath
    type: string
  - name: environmentName
    type: string
  - name: serviceConnection
    type: string
  - name: terraformVersion
    type: string
    default: '1.5.7'

steps:
- task: TerraformInstaller@0
  displayName: 'Install Terraform ${{ parameters.terraformVersion }}'
  inputs:
    terraformVersion: ${{ parameters.terraformVersion }}

- task: AzureCLI@2
  displayName: 'Initialize ${{ parameters.environmentName }} Terraform Infrastructure'
  inputs:
    azureSubscription: ${{ parameters.serviceConnection }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "üöÄ Initializing ${{ parameters.environmentName }} workspace with TRL naming conventions..."
      cd ${{ parameters.workspacePath }}
      
      # Initialize Terraform with backend configuration
      terraform init \
        -backend-config="subscription_id=$(subscription-id)" \
        -backend-config="tenant_id=$(tenant-id)"
      
      # Validate configuration
      echo "‚úÖ Validating Terraform configuration..."
      terraform validate
      
      # Format check
      echo "üîç Checking Terraform formatting..."
      terraform fmt -check -recursive
      
      echo "‚ú® ${{ parameters.environmentName }} workspace initialization completed successfully"
      echo "üìã Resources will follow naming pattern: {resource-type}-{ENV}-{LOCATION}-{purpose}-{instance}"

- task: PublishPipelineArtifact@1
  displayName: 'Publish ${{ parameters.environmentName }} Terraform Cache'
  inputs:
    targetPath: '${{ parameters.workspacePath }}/.terraform'
    artifact: '${{ parameters.environmentName }}-terraform-cache'
